<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="ILRepacker" AfterTargets="Build;AfterRebuild" BeforeTargets="PostBuildEvent"
    Condition="'$(ILRepackExecuted)' != 'true'" >

    <!-- 実行フラグを設定 -->
    <PropertyGroup>
      <ILRepackExecuted>true</ILRepackExecuted>
    </PropertyGroup>

    <!-- 元のファイルをバックアップ -->
    <Copy SourceFiles="$(OutputPath)\$(AssemblyName).dll" DestinationFiles="$(OutputPath)\$(AssemblyName).dll.orig" />

    <ItemGroup>
      <!-- プライマリアセンブリを最初に配置 -->
      <InputAssemblies Include="$(OutputPath)\$(AssemblyName).dll" />
      <!--
      <InputAssemblies Include="$(OutputPath)\YmmeUtil.Bridge.dll" />
      <InputAssemblies Include="$(OutputPath)\YmmeUtil.Ymm4.dll" />
      <InputAssemblies Include="$(OutputPath)\YmmeUtil.Common.dll" />
      -->

      <!-- Epoxyと関連ライブラリもマージ -->
      <InputAssemblies Include="$(OutputPath)\Epoxy.dll" Condition="Exists('$(OutputPath)\Epoxy.dll')" />
      <InputAssemblies Include="$(OutputPath)\Epoxy.Core.dll" Condition="Exists('$(OutputPath)\Epoxy.Core.dll')" />
      <InputAssemblies Include="$(OutputPath)\Epoxy.Wpf.dll" Condition="Exists('$(OutputPath)\Epoxy.Wpf.dll')" />
      <!--
      <InputAssemblies Include="$(OutputPath)\Dynamitey.dll" Condition="Exists('$(OutputPath)\Dynamitey.dll')" />
      <InputAssemblies Include="$(OutputPath)\ImpromptuInterface.dll" Condition="Exists('$(OutputPath)\ImpromptuInterface.dll')" />
      <InputAssemblies Include="$(OutputPath)\Nlog.dll" Condition="Exists('$(OutputPath)\Nlog.dll')" />
      <InputAssemblies Include="$(OutputPath)\Nlog.Extensions.Logging.dll" Condition="Exists('$(OutputPath)\Nlog.Extensions.Logging.dll')" />
      -->

      <!--
      Material.Iconsはdllマージすると表示されない
      <InputAssemblies Include="$(OutputPath)\Material.Icons.dll" Condition="Exists('$(OutputPath)\Material.Icons.dll')" />
      <InputAssemblies Include="$(OutputPath)\Material.Icons.WPF.dll" Condition="Exists('$(OutputPath)\Material.Icons.WPF.dll')" />
      <InputAssemblies Include="$(OutputPath)\Enterwell.Clients.Wpf.Notifications.dll" />
      -->

      <!-- YmmeUtilの依存関係も追加 -->
       <!--
      <InputAssemblies Include="$(OutputPath)\BigHelp.Http.dll" Condition="Exists('$(OutputPath)\BigHelp.Http.dll')" />
      <InputAssemblies Include="$(OutputPath)\ByteSize.dll" Condition="Exists('$(OutputPath)\ByteSize.dll')" />
      <InputAssemblies Include="$(OutputPath)\GithubReleaseDownloader.dll" Condition="Exists('$(OutputPath)\GithubReleaseDownloader.dll')" />
      <InputAssemblies Include="$(OutputPath)\Mayerch1.GithubUpdateCheck.dll" Condition="Exists('$(OutputPath)\Mayerch1.GithubUpdateCheck.dll')" />
      -->
    </ItemGroup>

    <ItemGroup>
      <DoNotInternalizeAssemblies Include="System" />
      <DoNotInternalizeAssemblies Include="YukkuriMovieMaker" />
      <DoNotInternalizeAssemblies Include="YukkuriMovieMaker.Plugin" />
      <DoNotInternalizeAssemblies Include="YukkuriMovieMaker.Controls" />
      <DoNotInternalizeAssemblies Include="ReactiveProperty" />
      <DoNotInternalizeAssemblies Include="ReactiveProperty.Core" />
      <DoNotInternalizeAssemblies Include="Microsoft.Extensions.Logging.Abstractions" />
    </ItemGroup>

    <ItemGroup>
      <LibraryPath Include="$(YMM4_PATH)" />
      <LibraryPath Include="$(OutputPath)" />
    </ItemGroup>

    <!-- 一時的な出力ファイルを使用 -->
    <ILRepack
      Parallel="true"
      Internalize="false"
      InternalizeExclude="@(DoNotInternalizeAssemblies)"
      InputAssemblies="@(InputAssemblies)"
      LibraryPath="@(LibraryPath)"
      TargetKind="Dll"
      OutputFile="$(OutputPath)\$(AssemblyName).dll"
      Union="true"
      XmlDocumentation="false"
      LogFile="$(OutputPath)\ILRepack.log"
      DebugInfo="true"
      Verbose="false"
      AllowDuplicateResources="true"
      />

    <!-- マージされたDLLファイルを削除 -->
    <Delete Files="$(OutputPath)\YmmeUtil.Bridge.dll" ContinueOnError="true" />
    <Delete Files="$(OutputPath)\YmmeUtil.Ymm4.dll" ContinueOnError="true" />
    <Delete Files="$(OutputPath)\YmmeUtil.Common.dll" ContinueOnError="true" />

    <Delete Files="$(OutputPath)\Epoxy.dll" ContinueOnError="true" />
    <Delete Files="$(OutputPath)\Epoxy.Core.dll" ContinueOnError="true" />
    <Delete Files="$(OutputPath)\Epoxy.Wpf.dll" ContinueOnError="true" />

    <Delete Files="$(OutputPath)\Dynamitey.dll" ContinueOnError="true" />
    <Delete Files="$(OutputPath)\ImpromptuInterface.dll" ContinueOnError="true" />

    <Delete Files="$(OutputPath)\NLog.dll" ContinueOnError="true" />
    <Delete Files="$(OutputPath)\NLog.Extensions.Logging.dll" ContinueOnError="true" />

    <!-- Material.Icons関連を削除 -->
    <!--
    <Delete Files="$(OutputPath)\Enterwell.Clients.Wpf.Notifications.dll" ContinueOnError="true" />
    <Delete Files="$(OutputPath)\Material.Icons.dll" ContinueOnError="true" />
    <Delete Files="$(OutputPath)\Material.Icons.WPF.dll" ContinueOnError="true" />
    -->

    <!-- YmmeUtilの依存関係も削除 -->
    <Delete Files="$(OutputPath)\BigHelp.Http.dll" ContinueOnError="true" />
    <Delete Files="$(OutputPath)\ByteSize.dll" ContinueOnError="true" />
    <Delete Files="$(OutputPath)\GithubReleaseDownloader.dll" ContinueOnError="true" />
    <Delete Files="$(OutputPath)\Mayerch1.GithubUpdateCheck.dll" ContinueOnError="true" />

    <!-- マージが成功したかを確認 -->
    <Message Text="ILRepack completed. Merged assemblies removed." Importance="high" />

  </Target>

  <!-- 重複実行を防ぐためのプロパティ設定 -->
  <PropertyGroup>
    <ILRepackExecuted Condition="'$(ILRepackExecuted)' == ''">false</ILRepackExecuted>
  </PropertyGroup>
</Project>